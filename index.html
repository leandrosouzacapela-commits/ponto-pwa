<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Ponto</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #0b1220, #0f172a);
  color: #ffffff;
  text-align: center;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 20px;
}

h1 { font-size: 36px; margin-bottom: 20px; }

.info { margin: 6px 0; font-size: 18px; }

button {
  width: 100%;
  padding: 22px;
  margin: 14px 0;
  font-size: 22px;
  border-radius: 12px;
  border: none;
  color: #fff;
  cursor: pointer;
}

.btn-entrar { background: #22c55e; }
.btn-sair   { background: #ef4444; }
.btn-rel    { background: #2563eb; }

.status-box {
  margin: 18px 0;
  padding: 14px;
  border-radius: 10px;
  font-size: 20px;
  background: #16a34a;
}

.status-erro {
  background: #dc2626;
}

.hidden { display: none; }

/* ===== RELAT√ìRIO ===== */
#relatorio {
  display: none;
  background: #ffffff;
  color: #000;
  padding: 25px;
  margin-top: 20px;
  text-align: left;
}

#relatorio * { color: #000; }

.resumo {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 15px 0 20px 0;
}

.caixa {
  border: 2px solid #2563eb;
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  font-weight: bold;
}

@media print {
  body { background: #fff; color: #000; }
  .container > *:not(#relatorio) { display: none !important; }
  #relatorio { display: block !important; }
}
</style>
</head>

<body>

<div class="container">

  <h1>Controle de Ponto</h1>

  <div class="info"><strong>Funcion√°rio:</strong></div>
  <div class="info">
    <input id="nomeFuncionario"
      value="EDENILSON DE SOUZA PEREIRA"
      onblur="localStorage.setItem('nomeFuncionario',this.value)"
      style="background:transparent;border:none;color:#fff;font-size:18px;font-weight:bold;text-align:center;width:100%;outline:none;">
  </div>

  <div class="info" id="dataHora"></div>
  <div class="info" id="statusAtual"></div>
  <div class="info" id="ultimaAcao"></div>

  <button class="btn-entrar" onclick="registrar('ENTRADA')">ENTRAR</button>
  <button class="btn-sair" onclick="registrar('SAIDA')">SAIR</button>

  <div id="statusEnvio" class="status-box hidden">‚úî Registro sincronizado</div>

  <button class="btn-rel" onclick="abrirRelatorio()">RELAT√ìRIO / PDF</button>

  <div id="relatorio">
    <h2 style="text-align:center">RELAT√ìRIO DE PONTO</h2>
    <h3 id="tituloFuncionario" style="text-align:center"></h3>
    <div id="periodoRelatorio" style="text-align:center;font-weight:bold"></div>

    <div class="resumo">
      <div class="caixa">DIA<br><span id="rDia">00h:00min</span></div>
      <div class="caixa">SEMANA<br><span id="rSemana">00h:00min</span></div>
      <div class="caixa">M√äS<br><span id="rMes">00h:00min</span></div>
      <div class="caixa">ANO<br><span id="rAno">00h:00min</span></div>
    </div>

    <div id="listaRegistros"></div>

    <br>
    <button onclick="window.print()">Imprimir / Salvar PDF</button>
  </div>

</div>

<script>
/* ================= CONFIG SUPABASE ================= */
/* üî¥ TROQUE ESTES 2 VALORES */
const SUPABASE_URL = "https://SEU_PROJETO.supabase.co";
const SUPABASE_ANON_KEY = "SUA_ANON_PUBLIC_KEY";
/* ================================================== */

setInterval(()=> {
  const d=new Date();
  dataHora.innerText="Hoje: "+d.toLocaleDateString()+" ‚Äî "+d.toLocaleTimeString();
},1000);

if(localStorage.getItem("nomeFuncionario"))
  nomeFuncionario.value=localStorage.getItem("nomeFuncionario");

function getEstado(){ return localStorage.getItem("estado") || "FORA"; }
function setEstado(e){
  localStorage.setItem("estado",e);
  statusAtual.innerText="Status: "+(e==="DENTRO"?"Em servi√ßo":"Fora");
}
setEstado(getEstado());

async function enviarSupabase(nome,tipo,iso){
  try{
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/registros_ponto`,
      {
        method:"POST",
        headers:{
          "apikey":SUPABASE_ANON_KEY,
          "Authorization":"Bearer "+SUPABASE_ANON_KEY,
          "Content-Type":"application/json",
          "Prefer":"return=minimal"
        },
        body:JSON.stringify({
          nome:nome,
          tipo:tipo,
          data_hora:iso,
          origem:"PWA"
        })
      }
    );

    if(!res.ok) throw new Error(await res.text());

    statusEnvio.innerText="‚úî Registro sincronizado";
    statusEnvio.className="status-box";
    statusEnvio.classList.remove("hidden");

  }catch(e){
    statusEnvio.innerText="üî¥ Erro ao sincronizar (offline)";
    statusEnvio.className="status-box status-erro";
    statusEnvio.classList.remove("hidden");
  }
}

function registrar(tipo){

  if(tipo==="ENTRADA" && getEstado()==="DENTRO") return;
  if(tipo==="SAIDA" && getEstado()==="FORA") return;

  const agora=new Date();
  const iso=agora.toISOString();
  const nome=nomeFuncionario.value.trim()||"SEM NOME";

  const dados=JSON.parse(localStorage.getItem("pontos")||"[]");
  dados.push({tipo,iso});
  localStorage.setItem("pontos",JSON.stringify(dados));

  setEstado(tipo==="ENTRADA"?"DENTRO":"FORA");
  ultimaAcao.innerText=`√öltima a√ß√£o: ${tipo} √†s ${agora.toLocaleTimeString()}`;

  enviarSupabase(nome,tipo,iso);
}

/* ===== RELAT√ìRIO ===== */
function abrirRelatorio(){
  relatorio.style.display=relatorio.style.display==="none"?"block":"none";
  gerarRelatorio();
}

function minToTxt(min){
  return String(Math.floor(min/60)).padStart(2,"0")+"h:"+String(min%60).padStart(2,"0")+"min";
}

function gerarRelatorio(){
  const regs=JSON.parse(localStorage.getItem("pontos")||"[]");
  const hoje=new Date();
  let dia=0,sem=0,mes=0,ano=0;
  let html="",datas=[];

  for(let i=0;i<regs.length;i++){
    const r=regs[i];
    const d=new Date(r.iso);
    datas.push(d);
    html+=`${d.toLocaleDateString()} ‚Äî ${r.tipo} ‚Äî ${d.toLocaleTimeString()}<br>`;

    if(r.tipo==="ENTRADA" && regs[i+1]?.tipo==="SAIDA"){
      const s=new Date(regs[i+1].iso);
      const min=Math.round((s-d)/60000);

      if(d.toDateString()===hoje.toDateString()) dia+=min;
      if(d.getMonth()===hoje.getMonth()) mes+=min;
      if(d.getFullYear()===hoje.getFullYear()) ano+=min;
      sem+=min;
    }
  }

  tituloFuncionario.innerText="NOME: "+nomeFuncionario.value;
  if(datas.length)
    periodoRelatorio.innerText="PER√çODO: "+datas[0].toLocaleDateString()+" a "+datas[datas.length-1].toLocaleDateString();

  rDia.innerText=minToTxt(dia);
  rSemana.innerText=minToTxt(sem);
  rMes.innerText=minToTxt(mes);
  rAno.innerText=minToTxt(ano);

  listaRegistros.innerHTML=html||"<em>Nenhum registro.</em>";
}
</script>

</body>
</html>
